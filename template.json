{
    " $ schema " : " https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json# " ,
    " contentVersion " : " 1.0.0.0 " ,
    " parâmetros " : {
        " adminUsername " : {
            " tipo " : " String " ,
            " metadados " : {
                " descrição " : " Nome de usuário do administrador para os servidores backend "
            }
        },
        " adminPassword " : {
            " tipo " : " SecureString " ,
            " metadados " : {
                " descrição " : " Senha para a conta de administrador nos servidores backend "
            }
        },
        " localização " : {
            " defaultValue " : " [resourceGroup (). location] " ,
            " tipo " : " String " ,
            " metadados " : {
                " descrição " : " Localização de todos os recursos. "
            }
        },
        " vmSize " : {
            " defaultValue " : " Standard_B2ms " ,
            " tipo " : " String " ,
            " metadados " : {
                " descrição " : " Tamanho da máquina virtual. "
            }
        }
    },
    " variáveis " : {
        " virtualMachines_VM_name " : " VM " ,
        " virtualNetworks_myVNet_name " : " myVNet " ,
        " net_interface " : " net-int " ,
        " ipconfig_name " : " ipconfig " ,
        " publicIPAddress " : " public_ip " ,
        " nsg_name " : " vm-nsg " ,
        " vnet_prefix " : " 10.0.0.0/16 " ,
        " Finet_subnet_prefix " : " 10.0.0.0/24 "
    },
    " recursos " : [
        {
            " tipo " : " Microsoft.Network/networkSecurityGroups " ,
            " apiVersion " : " 01/11/2019 " ,
            " nome " : " [concat (variáveis ​​('nsg_name'), copyIndex (1))] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " propriedades " : {
                " securityRules " : [
                    {
                        " nome " : " RDP " ,
                        " propriedades " : {
                            " protocolo " : " TCP " ,
                            " sourcePortRange " : " * " ,
                            " destinationPortRange " : " 3389 " ,
                            " sourceAddressPrefix " : " * " ,
                            " destinationAddressPrefix " : " * " ,
                            " access " : " Allow " ,
                            " prioridade " : 300 ,
                            " direção " : " Entrada "
                        }
                    }
                ]
            },
            " copiar " : {
                " nome " : " nsg-loop " ,
                " contar " : 6
            }
        },
        {
            " tipo " : " Microsoft.Network/publicIPAddresses " ,
            " apiVersion " : " 01/11/2019 " ,
            " name " : " [concat (variables ('publicIPAddress'), copyIndex ())] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " sku " : {
                " nome " : " Padrão "
            },
            " propriedades " : {
                " publicIPAddressVersion " : " IPv4 " ,
                " publicIPAllocationMethod " : " Estático " ,
                " idleTimeoutInMinutes " : 4
            },
            " copiar " : {
                " nome " : " publicip-loop " ,
                " contar " : 7
            }
        },
        {
            " tipo " : " Microsoft.Network/virtualNetworks " ,
            " apiVersion " : " 01/11/2019 " ,
            " name " : " [variables ('virtualNetworks_myVNet_name')] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " propriedades " : {
                " addressSpace " : {
                    " addressPrefixes " : [
                        " [variáveis ​​('vnet_prefix')] "
                    ]
                },
                " sub-redes " : [
                    {
                        " name " : " myBackendSubnet " ,
                        " propriedades " : {
                            " addressPrefix " : " [variables ('Finet_subnet_prefix')] " ,
                            " privateEndpointNetworkPolicies " : " Ativado " ,
                            " privateLinkServiceNetworkPolicies " : " Ativado "
                        }
                    }
                ],
                " enableDdosProtection " : falso ,
                " enableVmProtection " : false
            }
        },
        {
            " tipo " : " Microsoft.Compute / virtualMachines " ,
            " apiVersion " : " 01/07/2019 " ,
            " nome " : " [concat (variáveis ​​('virtualMachines_VM_name'), copyIndex (1))] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " dependsOn " : [
                " [resourceId ('Microsoft.Network/networkInterfaces', concat (variables ('net_interface'), copyIndex (1)))] "
            ],
            " propriedades " : {
                " hardwareProfile " : {
                    " vmSize " : " [parâmetros ('vmSize')] "
                },
                " storageProfile " : {
                    " imageReference " : {
                        " publisher " : " MicrosoftWindowsServer " ,
                        " oferta " : " WindowsServer " ,
                        " sku " : " 2016-Datacenter " ,
                        " versão " : " mais recente "
                    },
                    " osDisk " : {
                        " osType " : " Windows " ,
                        " createOption " : " FromImage " ,
                        " caching " : " ReadWrite " ,
                        " managedDisk " : {
                            " storageAccountType " : " StandardSSD_LRS "
                        },
                        " diskSizeGB " : 127
                    }
                },
                " osProfile " : {
                    " computerName " : " [concat (variables ('virtualMachines_VM_name'), copyIndex (1))] " ,
                    " adminUsername " : " [parâmetros ('adminUsername')] " ,
                    " adminPassword " : " [parameters ('adminPassword')] " ,
                    " windowsConfiguration " : {
                        " provisionVMAgent " : verdadeiro ,
                        " enableAutomaticUpdates " : true
                    },
                    " allowExtensionOperations " : true
                },
                " networkProfile " : {
                    " networkInterfaces " : [
                        {
                            " id " : " [resourceId ('Microsoft.Network/networkInterfaces', concat (variables ('net_interface'), copyIndex (1)))] "
                        }
                    ]
                }
            },
            " copiar " : {
                " nome " : " vm-loop " ,
                " contar " : 6
            }
        },
        {
            " tipo " : " Microsoft.Compute / virtualMachines / extensions " ,
            " apiVersion " : " 01/07/2019 " ,
            " nome " : " [concat (variáveis ​​('virtualMachines_VM_name'), copyIndex (1), '/ IIS')] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " dependsOn " : [
                " [resourceId ('Microsoft.Compute / virtualMachines', concat (variables ('virtualMachines_VM_name'), copyIndex (1)))] "
            ],
            " propriedades " : {
                " autoUpgradeMinorVersion " : verdadeiro ,
                " publisher " : " Microsoft.Compute " ,
                " type " : " CustomScriptExtension " ,
                " typeHandlerVersion " : " 1.4 " ,
                " configurações " : {
                    " fileUris " : [
                        " https://raw.githubusercontent.com/carlosfinet/AzureTemplates/master/IIS.ps1 "
                    ],
                    " commandToExecute " : " powershell.exe -ExecutionPolicy Unrestricted -File IIS.ps1 " ,
                    " managedIdentity " : {}
                }
            },
            " copiar " : {
                " nome " : " ext-loop " ,
                " contar " : 6
            }
        },
        {
            " tipo " : " Microsoft.Network/networkInterfaces " ,
            " apiVersion " : " 01/11/2019 " ,
            " nome " : " [concat (variáveis ​​('net_interface'), copyIndex (1))] " ,
            " localização " : " [parâmetros ('localização')] " ,
            " dependsOn " : [
                " [resourceId ('Microsoft.Network/publicIPAddresses', concat (variables ('publicIPAddress'), copyIndex (1)))] " ,
                " [resourceId ('Microsoft.Network/virtualNetworks', variables ('virtualNetworks_myVNet_name'))] " ,
                " [resourceId ('Microsoft.Network/networkSecurityGroups', concat (variables ('nsg_name'), copyIndex (1)))] "
            ],
            " propriedades " : {
                " ipConfigurations " : [
                    {
                        " nome " : " [concat (variáveis ​​('ipconfig_name'), copyIndex (1))] " ,
                        " propriedades " : {
                            " privateIPAllocationMethod " : " Dinâmico " ,
                            " publicIPAddress " : {
                                " id " : " [resourceId ('Microsoft.Network/publicIPAddresses', concat (variables ('publicIPAddress'), copyIndex (1)))] "
                            },
                            " sub-rede " : {
                                " id " : " [resourceId ('Microsoft.Network/virtualNetworks/subnets', variables ('virtualNetworks_myVNet_name'), 'myBackendSubnet')] "
                            },
                            " primário " : verdadeiro ,
                            " privateIPAddressVersion " : " IPv4 "
                        }
                    }
                ],
                " enableAcceleratedNetworking " : false ,
                " enableIPForwarding " : falso ,
                " networkSecurityGroup " : {
                    " id " : " [resourceId ('Microsoft.Network/networkSecurityGroups', concat (variables ('nsg_name'), copyIndex (1)))] "
                }
            },
            " copiar " : {
                " nome " : " int-loop " ,
                " contar " : 6
            }
        }
    ]
}
